<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; border-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        table { margin-top: 20px; }
        .search-container { margin-bottom: 20px; }
        .search-container input { width: 100%; max-width: 400px; }
        .loading { color: #007bff; font-style: italic; }
        .preview-text { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 200px; overflow-y: auto; }
        .camera-container { display: none; margin: 20px 0; text-align: center; }
        #cameraPreview { max-width: 100%; border: 2px solid #ddd; border-radius: 10px; }
        .camera-buttons { margin-top: 10px; }
        .image-preview { max-width: 200px; margin: 10px; border-radius: 5px; }
        .tab-content { margin-top: 20px; }
        .correct-btn { margin: 2px; padding: 2px 8px; font-size: 12px; }
        .extraction-row { background: #e9ecef; margin: 5px 0; padding: 10px; border-radius: 5px; }
        .capture-instruction { color: #666; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4 mb-4">
            <h1 class="text-center mb-4">Business Card Scanner</h1>
            <p class="text-center text-muted">Upload or capture business card images using your camera. AI-powered OCR extracts details with high precision.</p>
            
            <!-- Tabs for Upload vs Camera -->
            <ul class="nav nav-tabs" id="imageSourceTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">Upload Image</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button" onclick="handleCameraTabClick()">Use Camera</button>
                </li>
            </ul>
            
            <div class="tab-content" id="imageSourceTabContent">
                <!-- Upload Tab -->
                <div class="tab-pane fade show active" id="upload" role="tabpanel">
                    <div class="row mb-3 mt-3">
                        <div class="col-md-6">
                            <label for="frontImage" class="form-label">Front Image:</label>
                            <input type="file" class="form-control" id="frontImage" accept="image/*" capture="environment">
                            <div class="mt-2">
                                <img id="frontPreview" class="image-preview" style="display:none;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="backImage" class="form-label">Back Image (optional):</label>
                            <input type="file" class="form-control" id="backImage" accept="image/*" capture="environment">
                            <div class="mt-2">
                                <img id="backPreview" class="image-preview" style="display:none;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Camera Tab -->
                <div class="tab-pane fade" id="camera" role="tabpanel">
                    <div class="camera-container" id="cameraContainer">
                        <video id="cameraPreview" autoplay playsinline></video>
                        <div class="camera-buttons">
                            <button class="btn btn-primary" onclick="captureFront()">Capture Front</button>
                            <button class="btn btn-secondary" id="captureBackBtn" onclick="captureBack()">Capture Back</button>
                            <button class="btn btn-danger" onclick="stopCamera()">Stop Camera</button>
                        </div>
                        <div class="capture-instruction" id="captureInstruction">
                            Camera will automatically close after capturing both sides
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Front Capture:</h6>
                                <img id="frontCameraPreview" class="image-preview" style="display:none;">
                            </div>
                            <div class="col-md-6">
                                <h6>Back Capture:</h6>
                                <img id="backCameraPreview" class="image-preview" style="display:none;">
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-success" onclick="startCamera()" id="startCameraBtn">Start Camera</button>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap mt-3">
                <button class="btn btn-primary" onclick="scanCards()">Scan Card with AI</button>
                <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
                <button class="btn btn-danger" onclick="clearTable()">Clear Table</button>
                <button class="btn btn-warning" onclick="saveToLocalStorage()">Save to Browser</button>
                <button class="btn btn-info" onclick="loadFromLocalStorage()">Load from Browser</button>
            </div>
            
            <!-- Manual Correction Section -->
            <div id="correctionSection" style="display: none;" class="mt-4">
                <h5>Verify & Correct Extraction:</h5>
                <div id="correctionFields"></div>
                <button class="btn btn-success mt-2" onclick="saveCorrectedData()">Save Corrected Data</button>
            </div>
            
            <div id="previewSection" style="display: none;">
                <h5>AI Analysis Results:</h5>
                <div class="preview-text" id="extractedText"></div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="search-container">
                <input type="text" class="form-control" id="searchInput" placeholder="Search in table (e.g., company name, email)...">
            </div>
            
            <table class="table table-striped table-hover" id="dataTable">
                <thead class="table-dark">
                    <tr>
                        <th>Company Name</th>
                        <th>Contact Person</th>
                        <th>Mobile Number</th>
                        <th>Email ID</th>
                        <th>Designation</th>
                        <th>Website</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let stream = null;
        let frontCameraImage = null;
        let backCameraImage = null;
        let currentExtractedData = null;
        let rawOcrText = '';
        let autoCloseTimer = null;
        
        window.onload = function() {
            loadFromLocalStorage();
            setupImagePreviews();
            
            // Close camera when switching tabs
            document.getElementById('upload-tab').addEventListener('click', function() {
                stopCamera();
            });
        };
        
        function handleCameraTabClick() {
            // If camera is already on, do nothing
            if (!stream) {
                // Start camera automatically when tab is clicked
                setTimeout(startCamera, 100);
            }
        }
        
        function setupImagePreviews() {
            document.getElementById('frontImage').addEventListener('change', function(e) {
                previewImage(e.target, 'frontPreview');
            });
            
            document.getElementById('backImage').addEventListener('change', function(e) {
                previewImage(e.target, 'backPreview');
            });
        }
        
        function previewImage(input, previewId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Camera functions
        async function startCamera() {
            try {
                stopCamera(); // Stop any existing stream
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false 
                });
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('startCameraBtn').style.display = 'none';
                
                // Show capture instructions
                document.getElementById('captureInstruction').style.display = 'block';
                
                // Clear any existing images
                document.getElementById('frontCameraPreview').style.display = 'none';
                document.getElementById('backCameraPreview').style.display = 'none';
                frontCameraImage = null;
                backCameraImage = null;
                
            } catch (err) {
                console.error('Camera error:', err);
                alert('Cannot access camera: ' + err.message);
                // Fallback to file upload tab
                document.getElementById('upload-tab').click();
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
                stream = null;
            }
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'inline-block';
            document.getElementById('captureInstruction').style.display = 'none';
            
            // Clear any auto-close timer
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
                autoCloseTimer = null;
            }
        }
        
        function captureFront() {
            if (!stream) {
                alert('Camera is not active. Please start camera first.');
                return;
            }
            
            captureImage('frontCameraPreview');
            frontCameraImage = getCanvasImage();
            
            // Update UI
            document.getElementById('captureBackBtn').focus(); // Focus on back button
            document.getElementById('captureInstruction').innerHTML = 
                'Front captured! Now capture back side or scan now. Camera will close in 5 seconds...';
            
            // Auto-close camera after 5 seconds if back not captured
            setupAutoClose();
            
            alert('Front image captured!');
        }
        
        function captureBack() {
            if (!stream) {
                alert('Camera is not active. Please start camera first.');
                return;
            }
            
            captureImage('backCameraPreview');
            backCameraImage = getCanvasImage();
            
            // Update UI
            document.getElementById('captureInstruction').innerHTML = 
                'Both sides captured! Camera will close in 3 seconds...';
            
            // Auto-close camera after 3 seconds
            setupAutoClose(3000, true);
            
            alert('Back image captured! Both sides ready for scanning.');
        }
        
        function captureImage(previewId) {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Draw the current video frame
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Add a flash effect
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0';
            flash.style.left = '0';
            flash.style.width = '100%';
            flash.style.height = '100%';
            flash.style.backgroundColor = 'white';
            flash.style.opacity = '0.7';
            flash.style.zIndex = '9999';
            flash.style.pointerEvents = 'none';
            document.body.appendChild(flash);
            
            // Remove flash after 200ms
            setTimeout(() => {
                document.body.removeChild(flash);
            }, 200);
            
            // Show preview
            const img = document.getElementById(previewId);
            img.src = canvas.toDataURL('image/jpeg');
            img.style.display = 'block';
        }
        
        function getCanvasImage() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg');
        }
        
        function setupAutoClose(delay = 5000, bothCaptured = false) {
            // Clear any existing timer
            if (autoCloseTimer) {
                clearTimeout(autoCloseTimer);
            }
            
            // Set new timer
            autoCloseTimer = setTimeout(() => {
                stopCamera();
                
                if (bothCaptured) {
                    // Auto-switch to upload tab and start scanning
                    setTimeout(() => {
                        document.getElementById('upload-tab').click();
                        // Auto-click scan button after 1 second
                        setTimeout(() => {
                            if (confirm('Both images captured! Start scanning now?')) {
                                scanCards();
                            }
                        }, 1000);
                    }, 500);
                }
            }, delay);
        }
        
        function dataURLtoFile(dataurl, filename) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
        }
        
        async function scanCards() {
            let frontFile, backFile;
            let usingCamera = false;
            
            const activeTab = document.querySelector('#imageSourceTabContent .tab-pane.active').id;
            
            if (activeTab === 'camera') {
                usingCamera = true;
                if (!frontCameraImage) {
                    alert('Please capture front image first!');
                    return;
                }
                frontFile = dataURLtoFile(frontCameraImage, 'front.jpg');
                if (backCameraImage) {
                    backFile = dataURLtoFile(backCameraImage, 'back.jpg');
                }
            } else {
                frontFile = document.getElementById('frontImage').files[0];
                if (!frontFile) {
                    // Check if we have camera images
                    if (frontCameraImage) {
                        usingCamera = true;
                        frontFile = dataURLtoFile(frontCameraImage, 'front.jpg');
                        if (backCameraImage) {
                            backFile = dataURLtoFile(backCameraImage, 'back.jpg');
                        }
                    } else {
                        alert('Please upload front image or capture using camera!');
                        return;
                    }
                } else {
                    backFile = document.getElementById('backImage').files[0];
                }
            }
            
            // Stop camera if it's running
            if (stream || usingCamera) {
                stopCamera();
            }
            
            const tableBody = document.getElementById('tableBody');
            const loadingRow = document.createElement('tr');
            loadingRow.innerHTML = '<td colspan="7" class="loading text-center">AI Processing... This may take 15-30 seconds.</td>';
            tableBody.appendChild(loadingRow);
            
            try {
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('correctionSection').style.display = 'none';
                
                // OCR Processing
                const worker = await Tesseract.createWorker();
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                
                const frontResult = await worker.recognize(frontFile);
                let frontText = frontResult.data.text;
                
                let backText = '';
                if (backFile) {
                    const backResult = await worker.recognize(backFile);
                    backText = backResult.data.text;
                }
                
                await worker.terminate();
                
                rawOcrText = frontText + '\n' + backText;
                
                // IMPROVED AI Extraction with Smart Parsing
                currentExtractedData = extractBusinessCardDataSmart(rawOcrText);
                
                // Show extraction results
                document.getElementById('extractedText').innerHTML = `
                    <strong>Raw OCR Text:</strong><br>
                    <pre>${rawOcrText}</pre><br>
                    <strong>AI Extraction Results:</strong><br>
                    ${displayExtractionResults(currentExtractedData)}
                `;
                
                // Show correction interface
                showCorrectionInterface(currentExtractedData);
                
                tableBody.removeChild(loadingRow);
                
                // Reset inputs
                resetInputs(usingCamera);
                
            } catch (error) {
                alert('Error during scanning: ' + error.message);
                tableBody.removeChild(loadingRow);
            }
        }
        
        // [Keep all the extraction functions from previous version - they remain the same]
        function extractBusinessCardDataSmart(text) {
            // ... [Same extraction logic as before] ...
            text = text.replace(/\s+/g, ' ').trim();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            
            const data = {
                company: '',
                name: '',
                mobile: '',
                email: '',
                designation: '',
                website: '',
                location: ''
            };
            
            // Extract EMAIL
            const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi;
            const emails = [...text.matchAll(emailRegex)];
            if (emails.length > 0) {
                data.email = emails[0][0];
                const emailName = emails[0][0].split('@')[0];
                const nameParts = emailName.replace(/[._-]/g, ' ').split(' ');
                if (nameParts.length >= 2) {
                    const potentialName = nameParts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                    if (!data.name) data.name = potentialName;
                }
            }
            
            // Extract PHONE NUMBERS
            const phoneRegex = /(\+?(\d[\d\s-()]{7,}\d))/g;
            const phones = [...text.matchAll(phoneRegex)];
            if (phones.length > 0) {
                let phone = phones[0][0].replace(/\s+/g, '').replace(/[()\-]/g, '');
                if (phone.length >= 10) {
                    data.mobile = phone;
                }
            }
            
            // Extract WEBSITE
            const websiteRegex = /((www\.|https?:\/\/)[^\s]+)/gi;
            const websites = [...text.matchAll(websiteRegex)];
            if (websites.length > 0) {
                data.website = websites[0][0];
                if (data.website.includes('.')) {
                    const domain = data.website.split('/')[2] || data.website.split('/')[0];
                    const companyName = domain.split('.')[0];
                    if (companyName.length > 2 && !data.company) {
                        data.company = companyName.charAt(0).toUpperCase() + companyName.slice(1);
                    }
                }
            }
            
            // Analyze each line for NAME and DESIGNATION
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                const line = lines[i];
                
                if (line.includes('@') || line.includes('http') || /\d{8,}/.test(line)) {
                    continue;
                }
                
                const words = line.split(/\s+/);
                if (words.length >= 2 && words.length <= 4) {
                    const allStartWithCapital = words.every(w => /^[A-Z]/.test(w));
                    const hasCommonPrefix = /^(Mr|Ms|Mrs|Dr|Prof)\.?\s/i.test(line);
                    
                    if (allStartWithCapital || hasCommonPrefix) {
                        if (!data.name) {
                            data.name = line;
                            continue;
                        }
                    }
                }
                
                const designationPatterns = [
                    /(Sr\.?\s*|Jr\.?\s*)?(Manager|Director|CEO|CTO|CFO|President|VP|Head|Lead|Engineer|Developer|Analyst|Consultant)/i,
                    /(Senior|Junior)\s+(.*)/i
                ];
                
                for (const pattern of designationPatterns) {
                    const match = line.match(pattern);
                    if (match && !data.designation) {
                        data.designation = line;
                        break;
                    }
                }
            }
            
            // Extract COMPANY NAME
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                const line = lines[i];
                
                const companyIndicators = [
                    /(Inc|Corp|Corporation|LLC|Ltd|Limited|Co\.?|Company|Technologies|Solutions|Systems|Group|International|Global)/i,
                    /^[A-Z\s&]+$/
                ];
                
                for (const indicator of companyIndicators) {
                    if (indicator.test(line) && line.length > 3 && !data.company) {
                        data.company = line;
                        break;
                    }
                }
            }
            
            if (!data.company) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.length > 3 && 
                        !line.includes('@') && 
                        !line.includes('http') && 
                        !/\d{8,}/.test(line) &&
                        line !== data.name &&
                        line !== data.designation) {
                        data.company = line;
                        break;
                    }
                }
            }
            
            Object.keys(data).forEach(key => {
                if (data[key]) {
                    data[key] = data[key].trim();
                    data[key] = data[key].replace(/[.,;:\s]+$/, '');
                }
            });
            
            if (data.name) {
                const designationWords = ['manager', 'director', 'ceo', 'cto', 'cfo', 'president', 'vp', 'head', 'lead'];
                const nameWords = data.name.split(' ');
                const filteredName = nameWords.filter(word => 
                    !designationWords.includes(word.toLowerCase().replace(/[.,]/g, ''))
                );
                if (filteredName.length >= 2) {
                    data.name = filteredName.join(' ');
                }
            }
            
            return data;
        }
        
        function displayExtractionResults(data) {
            let html = '<div class="extraction-row">';
            for (const [key, value] of Object.entries(data)) {
                const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                html += `<strong>${label}:</strong> ${value || '<span style="color:red">Not found</span>'}<br>`;
            }
            html += '</div>';
            return html;
        }
        
        function showCorrectionInterface(data) {
            const container = document.getElementById('correctionFields');
            container.innerHTML = '';
            
            const fields = [
                { key: 'name', label: 'Contact Person', example: 'John Smith' },
                { key: 'company', label: 'Company Name', example: 'ABC Technologies Inc' },
                { key: 'mobile', label: 'Mobile Number', example: '+91 9876543210' },
                { key: 'email', label: 'Email ID', example: 'john@example.com' },
                { key: 'designation', label: 'Designation', example: 'Senior Manager' },
                { key: 'website', label: 'Website', example: 'www.example.com' },
                { key: 'location', label: 'Location', example: 'Mumbai, India' }
            ];
            
            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <label class="form-label">${field.label}:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="correct_${field.key}" 
                               value="${data[field.key] || ''}" placeholder="${field.example}">
                        <button class="btn btn-outline-secondary correct-btn" type="button" 
                                onclick="suggestFromText('${field.key}')">Suggest</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('correctionSection').style.display = 'block';
        }
        
        function suggestFromText(field) {
            const suggestions = extractSuggestionsFromText(rawOcrText, field);
            if (suggestions.length > 0) {
                const input = document.getElementById(`correct_${field}`);
                input.value = suggestions[0];
                input.focus();
            }
        }
        
        function extractSuggestionsFromText(text, field) {
            const lines = text.split('\n').map(l => l.trim());
            const suggestions = [];
            
            switch(field) {
                case 'name':
                    lines.forEach(line => {
                        const words = line.split(/\s+/);
                        if (words.length >= 2 && words.length <= 3 && 
                            words.every(w => /^[A-Z]/.test(w))) {
                            suggestions.push(line);
                        }
                    });
                    break;
                    
                case 'mobile':
                    const phoneRegex = /(\+?(\d[\d\s-()]{7,}\d))/g;
                    const phones = [...text.matchAll(phoneRegex)];
                    phones.forEach(p => suggestions.push(p[0].replace(/\s+/g, ' ')));
                    break;
                    
                case 'company':
                    lines.forEach(line => {
                        if (line.length > 3 && 
                            (line.includes('Inc') || line.includes('Corp') || 
                             line.includes('Ltd') || line.includes('Co.') ||
                             /^[A-Z\s&]+$/.test(line))) {
                            suggestions.push(line);
                        }
                    });
                    break;
            }
            
            return suggestions.slice(0, 3);
        }
        
        function saveCorrectedData() {
            const correctedData = {};
            const fields = ['name', 'company', 'mobile', 'email', 'designation', 'website', 'location'];
            
            fields.forEach(field => {
                const value = document.getElementById(`correct_${field}`).value.trim();
                correctedData[field] = value || 'N/A';
            });
            
            const tableBody = document.getElementById('tableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${correctedData.company}</td>
                <td>${correctedData.name}</td>
                <td>${correctedData.mobile}</td>
                <td>${correctedData.email}</td>
                <td>${correctedData.designation}</td>
                <td>${correctedData.website}</td>
                <td>${correctedData.location}</td>
            `;
            tableBody.appendChild(newRow);
            
            saveToLocalStorage();
            document.getElementById('correctionSection').style.display = 'none';
            
            alert('Data saved successfully!');
        }
        
        function resetInputs(usingCamera) {
            if (usingCamera) {
                frontCameraImage = null;
                backCameraImage = null;
                document.getElementById('frontCameraPreview').style.display = 'none';
                document.getElementById('backCameraPreview').style.display = 'none';
            } else {
                document.getElementById('frontImage').value = '';
                document.getElementById('backImage').value = '';
                document.getElementById('frontPreview').style.display = 'none';
                document.getElementById('backPreview').style.display = 'none';
            }
        }
        
        function exportToExcel() {
            const table = document.getElementById('dataTable');
            if (table.rows.length <= 1) {
                alert('No data to export. Scan some cards first.');
                return;
            }
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, `business_cards_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        function saveToLocalStorage() {
            const data = [];
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                data.push({
                    company: cells[0].textContent,
                    name: cells[1].textContent,
                    mobile: cells[2].textContent,
                    email: cells[3].textContent,
                    designation: cells[4].textContent,
                    website: cells[5].textContent,
                    location: cells[6].textContent
                });
            });
            localStorage.setItem('businessCards', JSON.stringify(data));
            alert('Data saved to browser storage!');
        }
        
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('businessCards');
            if (savedData) {
                const data = JSON.parse(savedData);
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                data.forEach(card => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${card.company || 'N/A'}</td>
                        <td>${card.name || 'N/A'}</td>
                        <td>${card.mobile || 'N/A'}</td>
                        <td>${card.email || 'N/A'}</td>
                        <td>${card.designation || 'N/A'}</td>
                        <td>${card.website || 'N/A'}</td>
                        <td>${card.location || 'N/A'}</td>
                    `;
                    tableBody.appendChild(newRow);
                });
            }
        }
        
        function clearTable() {
            if (confirm('Are you sure you want to clear all data?')) {
                document.getElementById('tableBody').innerHTML = '';
                localStorage.removeItem('businessCards');
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('correctionSection').style.display = 'none';
                alert('All data cleared.');
            }
        }
        
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
        
        // Close camera when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopCamera();
            }
        });
        
        // Close camera when user navigates away
        window.addEventListener('beforeunload', function() {
            stopCamera();
        });
    </script>
</body>
</html>
